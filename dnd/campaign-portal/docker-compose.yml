services:
  campaign-portal:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_HOST=http://localhost:8080
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_HOST=http://localhost:8080
    depends_on:
      - api
    networks:
      - app-network

  api:
    build:
      context: ./../../api
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:8080:8080"
      - "127.0.0.1:8081:8081"
    depends_on:
      - db
    env_file:
      - .env
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - RUNNING_IN_DOCKER=true
      - Certificate__Path=/run/secrets/certificate_pfx
      - Certificate__Password_FILE=/run/secrets/cert_password
      - Encryption__Key_FILE=/run/secrets/encryption_key
      - JwtSettings__SecretKey_FILE=/run/secrets/jwt_secret
      - JwtSettings__Issuer_FILE=/run/secrets/jwt_issuer
      - JwtSettings__Audience_FILE=/run/secrets/jwt_audience
      - ConnectionStrings__Postgres_FILE=/run/secrets/pg_connection_string
    secrets:
      - jwt_secret
      - cert_password
      - pg_password
      - encryption_key
      - jwt_issuer
      - jwt_audience
      - certificate_pfx
      - pg_connection_string
    volumes:
      - api_keys:/app/keys:rw
    user: "1000:1000"
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8080/health || exit 1" ]
      interval: 15s
      timeout: 3s
      retries: 3
    restart: unless-stopped
    networks:
      - app-network

  db:
    image: ghcr.io/cloudnative-pg/postgresql:15.4
    environment:
      - POSTGRES_USER_FILE=/run/secrets/pg_user
      - POSTGRES_DB_FILE=/run/secrets/pg_name
      - POSTGRES_PASSWORD_FILE=/run/secrets/pg_password
    secrets:
      - pg_user
      - pg_name
      - pg_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5433:5432"
    healthcheck:
      test: [
        "CMD-SHELL",
        'pg_isready -U "$(cat /run/secrets/pg_user 2>/dev/null || echo pi)" -d "$(cat /run/secrets/pg_name 2>/dev/null || echo app)" || exit 1'
      ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - app-network

  adminer:
    image: adminer
    depends_on:
      - db
    ports:
      - "127.0.0.1:8082:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=db
    restart: unless-stopped
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
  api_keys:

secrets:
  pg_user:
    file: ./../../api/secrets/pg_user
  pg_name:
    file: ./../../api/secrets/pg_name
  pg_password:
    file: ./../../api/secrets/pg_password
  jwt_secret:
    file: ./../../api/secrets/jwt_secret
  cert_password:
    file: ./../../api/secrets/cert_password
  encryption_key:
    file: ./../../api/secrets/encryption_key
  jwt_issuer:
    file: ./../../api/secrets/jwt_issuer
  jwt_audience:
    file: ./../../api/secrets/jwt_audience
  certificate_pfx:
    file: ./../../api/secrets/certificate.pfx
  pg_connection_string:
    file: ./../../api/secrets/pg_connection_string_development